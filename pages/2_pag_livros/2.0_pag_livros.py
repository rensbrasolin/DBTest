import streamlit as st
import pandas as pd
from st_aggrid import AgGrid
from manage_db.database import SessionLocal
from manage_db.models import Livro

st.title("P√°gina - Tabela Livros üìö")

# ----------------------------------------------------------- Conecta ao banco e carrega dados

session = SessionLocal()
lista_livros = session.query(Livro).all()
session.close()

# Prepara os dados em formato de DataFrame
dados = [
    {
        "ID": livro.id,
        "Data": livro.data,
        "T√≠tulo": livro.titulo,
        "Qtde P√°ginas": livro.qtde_paginas,
        "ID Usu√°rio": livro.id_usuario,
    }
    for livro in lista_livros
]

df_livros = pd.DataFrame(dados)

# ----------------------------------------------------------- bot√µes de a√ß√£o

col1, col2 = st.columns(2)  # üí¨ Divide a linha horizontalmente

# Adicionar
with col1:
    with st.container(border=True):
        # Bot√£o para ir para a p√°gina de cria√ß√£o de novo livro
        st.page_link(
            label="‚ûï Adicionar novo livro",
            page="pages/2_pag_livros/2.1_pag_livros_create.py",
            icon="üìó"
        )

# Editar
# Op√ß√£o ao selctbox √© mostrar o READ nao em df mas as linhas em 'objetos soltos'. Assim da pra acoplar um botao.
# Op√ß√£o 2 √© tentar com st.data_editor, se precisar, passar url da doc para gpt ler e ver se √© possivel. Inclusive perguntar: se passar s√≥ a home da doc, vc l√™ tudo?
with col2:
    with st.container(border=True):
        # Dicion√°rio {t√≠tulo: id} com op√ß√£o em branco no topo
        opcoes = {"": None, **{livro.titulo: livro.id for livro in lista_livros}}

        # Dropdown de t√≠tulos (inicia em branco)
        livro_titulo_selecionado = st.selectbox(
            "Selecione um livro para editar:",
            options=list(opcoes.keys())
        )

        # Bot√£o de editar, s√≥ funciona se um livro for selecionado
        if livro_titulo_selecionado and st.button("‚úèÔ∏è Editar Livro Selecionado"):
            st.session_state.id_livro_para_editar = opcoes[livro_titulo_selecionado]
            st.switch_page("pages/2_pag_livros/2.2_pag_livros_update.py")

# ----------------------------------------------------------- Separador visual
st.markdown("---")

# ----------------------------------------------------------- Exibi√ß√£o da tabela de livros
st.subheader("Lista de livros")
AgGrid(df_livros) # agrid fica aparecendo for trial use only. talvez melhor tentar com st.data_editor
